NCID Client, Gateway, and Server Protocol

File last changed by jlc on Wed May 12, 2010

The NCID-FORMAT file explains the lines sent to the client by the server.
It also explains lines sent by a gateway to the server.

Client Implementation:
        - connect to port 3333.
        - receive a connect line that identifies the server
        - possibly receive multiple CIDLOG lines (only at connect)
        - possibly receive a server MSG line
        - possibly receive a CIDINFO line at each ring
        - receive a CID line whenever a call comes in
        - receive a MSG line whenever a message is sent
        - ignore lines that do not begin with:
          200
          300
          CID:
          CIDLOG:
          MSG:
          MSGLOG:
          CIDINFO:
        - parse CID and CIDLOG lines based on name field pairs, a field
          name followed by the field data.  Do not assume the field pair
          order will stay constant between NCID versions
        - clients are allowed to connect and disconnect as they please
        - clients are allowed to send a text message to the server

Client Output Module Implementation:
        - call module using the ncid client, ncid-skel is a example
          output module using a shell script:
          ncid --no-gui [--message] --call-prog --program ncid-skel
        - read 5 lines of input from STDIN.  A line is a string of
          characters and may be a NULL string.  The lines are in the
          following order: 
            DATE
            TIME
            NMBR
            NAME
            LINE
        - check NMBR, if it is "", then a message was received using
          the NAME input
        - process the Caller ID or message

Gateway Implementation:
        - connect to port 3333.
        - read and ignore all lines from the server, including:
          a connect line that identifies the server
          and CIDLOG, MSGLOG, CID, and MSG lines
        - connect to Caller ID service
        - when CID information is obtained from the service, send the
          data to the server in the gateway CALL data Line format
        - if hangup detected before answer, send the data to the server
          in the gateway CALLINFO CANCEL line format
        - if hangup detected after answer, send the data to the server
          in the gateway CALLINFO BYE Line format
        - if outgoing call is detected, send the data to the server
          in the gateway CALLINFO CALLED Line format

Server Implementation:
        - listen to port 3333 for a connection,
        - send a connect line to identify the server
        - if configured, send the call log file (cidcall.log)
        - send a 300 line if a call log was sent (cidcall.log)
        - send a CID line when a call is received to connected clients
        - send a MSG line with a important server warning or a user message
        - send a CIDINFO line at each ring with a line indicator (default -)
          and the ring count
        - send a CIDINFO line after ringing stops, with a ring count of 0
        - maintain a constant TCP connection with the clients
        - detect clients  and gateways as they come and go
	    - if client sends text, sent it to all connected clients
	    - if gateway sends a line prefixed with CALL: treat it as CID data
          from a device
        - if a gateway sends a line prefixed with CALLINFO:, generate a
          CIDINFO: line, process CANCEL as a ring count of -1, and BYE
          as a ring count of -2
